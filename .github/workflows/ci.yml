name: CI¬†+¬†Publish

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    # 1. –∫–ª–æ–Ω–∏—Ä—É–µ–º
    - uses: actions/checkout@v4

    # 2. —Å—Ç–∞–≤–∏–º Python¬†3.11
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3. –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ + editable‚Äë—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
    - name: Install deps
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
        pip install pytest

    # 4. PyTest
    - name: Run tests
      run: pytest -q

  build-and-publish:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # —Å–±–æ—Ä–∫–∞ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞
    - run: |
        python -m pip install --upgrade build twine
        python -m build

    # –ø—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ PyPI
    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
      run: |
        twine upload dist/*

    # –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤¬†Hugging¬†Face
    - name: Login HF‚ÄØCLI
      env:
        HF_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
      run: echo "${HF_TOKEN}" | huggingface-cli login --token

    # –∑–∞–ª–∏–≤–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –≤¬†HF‚ÄëHub
    - name: Upload to Hugging¬†Face
      run: |
        Repo="voroninsergei/triz-ai-patent-assistant"
        huggingface-cli upload "${Repo}" dist/ \
          --repo-type model \
          --commit-message "ü§ñ Release ${{ github.ref_name }}"
